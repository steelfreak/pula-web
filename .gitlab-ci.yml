# -------------------------------------------------
# GLOBAL settings
# -------------------------------------------------
variables:
  NODE_VERSION: "22"
  YARN_CACHE_FOLDER: ".yarn-cache"
  NEXT_CACHE_FOLDER: ".next/cache"
  TOOLNAME: "agpb"                     # set your Toolforge tool name once
  PRIVATE_KEY_NAME: "id_rsa.toolforge"
  GITLAB_ACCESS_TOKEN: $GITLAB_ACCESS_TOKEN   # must have write_repository scope

stages:
  - build
  - deploy

# -------------------------------------------------
# 1️ Build – produces .next/standalone/
# -------------------------------------------------
build:
  stage: build
  image: node:${NODE_VERSION}
  tags:
    - wmcs
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never          # everything else is ignored
  cache:
    # Invalidate on every commit (cheap because we have a fast runner)
    key: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHA}"
    paths:
      - node_modules/
      - $YARN_CACHE_FOLDER
      - $NEXT_CACHE_FOLDER
  before_script:
    - yarn config set cache-folder $YARN_CACHE_FOLDER
  script:
    - yarn install --frozen-lockfile
    - yarn build
    - cp -r public .next/standalone/
    - cp -r .next/static .next/standalone/.next/
    - cp Procfile .next/standalone/
    - NODE_ENV=production node prune-package.js || true
  artifacts:
    name: "next‑standalone"
    paths:
      - .next/standalone/
    expire_in: 24 hour

# -------------------------------------------------
# 2️ Deploy template (now using the allowed node image)
# -------------------------------------------------
..deploy_template: &deploy_template
  # Use the same node image that the runner already trusts
  image: alpine:latest
  tags:
    - wmcs
  needs:
    - build               # pull the .next/standalone artifact
  dependencies:
    - build
  script:
    # -------------------------------------------------
    # 1️ Install the utilities we need (apt‑get)
    # -------------------------------------------------
  - apk add --no-cache curl openssh-client git bash

    # -------------------------------------------------
    # 2️ SSH key handling (unchanged)
    # -------------------------------------------------
  - mkdir -p ~/.ssh
  - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
  - curl --silent "https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer" | bash
  - mv $SECURE_FILES_DOWNLOAD_PATH/$PRIVATE_KEY_NAME ~/.ssh/
  - chmod 600 ~/.ssh/$PRIVATE_KEY_NAME

  # -------------------------------------------------
  # 3️ Git configuration
  # -------------------------------------------------
  - git config --global user.email "gitlab-ci@$CI_SERVER_HOST"
  - git config --global user.name "GitLab CI"

  # -------------------------------------------------
  # 4️ Ensure the target branch exists (no fresh repo)
  # -------------------------------------------------
  - git fetch origin $BRANCH || true
  - git checkout $BRANCH || git checkout -b $BRANCH

  # -------------------------------------------------
  # 5️ Sync the built folder (rsync copies hidden files, too)
  # -------------------------------------------------
  - echo "Syncing .next/standalone > repository"
  - rsync -a --delete .next/standalone/ .   # copies *everything* inside the repo root

  # -------------------------------------------------
  # 6️Commit & push
  # -------------------------------------------------
  - git add -A
  - git commit -m "Deploy $CI_COMMIT_SHORT_SHA – $CI_COMMIT_TITLE" || echo "nothing to commit"
  - echo "Pushing to $BRANCH"
  - git push origin $BRANCH --force

  # -------------------------------------------------
  # 7️ Build a fresh Toolforge image – unique tag so the service can’t reuse old one
  # -------------------------------------------------
  - |
    IMAGE_TAG="${BRANCH}-${CI_COMMIT_SHORT_SHA}"
    echo "Building Toolforge image $IMAGE_TAG"
    ssh -i "~/.ssh/$PRIVATE_KEY_NAME" "$SSH_USER@$SSH_HOST" <<'EOF'
      become $TOOLNAME
      toolforge build start --image-name "$IMAGE_TAG" \
        -L https://$CI_SERVER_HOST/$CI_PROJECT_PATH \
        --ref "$BRANCH"
      toolforge webservice buildservice restart --mount all
    EOF
# -------------------------------------------------
# 3️ Deploy jobs
# -------------------------------------------------
.deploy_job:
  stage: deploy
  variables:
    SSH_HOST: "login.tools.wmflabs.org"
    SSH_USER: "collins"
    ACCESS_TOKEN: $GITLAB_ACCESS_TOKEN
  <<: *deploy_template

deploy-dev:
  extends: .deploy_job
  environment: dev
  variables:
    BRANCH: "build-dev"
    NODE_ENV: "development"

deploy-beta:
  extends: .deploy_job
  environment: beta
  variables:
    BRANCH: "build-beta"
    NODE_ENV: "beta"

deploy-production:
  extends: .deploy_job
  environment: production
  variables:
    BRANCH: "build-production"
    NODE_ENV: "production"